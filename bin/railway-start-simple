#!/bin/bash

echo "=== Simple Railway Startup Script ==="
echo "Environment: $RAILS_ENV"
echo "Port: $PORT"

# Ensure RAILS_ENV is set to production
export RAILS_ENV=production

echo "=== Updated Environment: $RAILS_ENV ==="

# Create necessary directories
mkdir -p tmp/storage
mkdir -p storage
mkdir -p tmp/pids

echo "=== Testing basic Rails functionality ==="
# Test if Rails can load
if rails runner "puts 'Rails loaded successfully'" 2>&1; then
  echo "Rails loads: SUCCESS"
else
  echo "Rails loads: FAILED"
  exit 1
fi

echo "=== Testing database connection ==="
if rails runner "ActiveRecord::Base.connection.execute('SELECT 1')" 2>&1; then
  echo "Database connection: SUCCESS"
else
  echo "Database connection: FAILED"
  exit 1
fi

echo "=== Running database migrations ==="
if rails db:migrate 2>&1; then
  echo "Database migrations: SUCCESS"
else
  echo "Database migrations: FAILED - but continuing"
fi
echo "Starting Puma on port $PORT"
exec bundle exec puma -p $PORT -b tcp://0.0.0.0
