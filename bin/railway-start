#!/bin/bash

echo "=== Railway Startup Script ==="
echo "Environment: $RAILS_ENV"
echo "Port: $PORT"
echo "Database URL available: ${DATABASE_URL:+YES}"
echo "Secret Key Base available: ${SECRET_KEY_BASE:+YES}"
echo "Current directory: $(pwd)"
echo "Ruby version: $(ruby -v)"
echo "Bundle version: $(bundle -v)"

echo "=== Testing database connection ==="
if rails runner "ActiveRecord::Base.connection.execute('SELECT 1')" 2>&1; then
  echo "Database connection: SUCCESS"
else
  echo "Database connection: FAILED"
  exit 1
fi

echo "=== Setting up storage directories ==="
mkdir -p tmp/storage
mkdir -p storage
echo "Storage directories created"

echo "=== Testing Active Storage configuration ==="
if rails runner "puts ActiveStorage::Blob.service.class" 2>&1; then
  echo "Active Storage configuration: SUCCESS"
else
  echo "Active Storage configuration: FAILED"
  exit 1
fi

echo "=== Running database migrations ==="
# Try to run migrations with better error handling
if rails db:migrate 2>&1; then
  echo "Database migrations: SUCCESS"
else
  echo "Database migrations: FAILED - trying to continue anyway"
  echo "=== Attempting to skip Active Storage migration ==="
  # Try to run a specific migration version to avoid Active Storage issues
  if rails db:migrate VERSION=20220706203007 2>&1; then
    echo "Basic migrations completed successfully"
  else
    echo "Even basic migrations failed - this might be a more serious issue"
  fi
fi

echo "=== Starting Puma server ==="
echo "Binding to: 0.0.0.0:$PORT"
exec bundle exec puma -C config/puma.rb
